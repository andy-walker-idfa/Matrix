# Matrix Server Deployment Status

## Working Configuration (2026-01-08)

### Container Status
All services running successfully:

| Container | Image | Status | Ports | Notes |
|-----------|-------|--------|-------|-------|
| matrix-nginx | nginx:latest | ✅ Healthy | 80, 443, 8448 | Reverse proxy with SSL |
| matrix-auth-service | ghcr.io/element-hq/matrix-authentication-service:latest | ✅ Running | Internal:8080 | MAS OAuth/OIDC provider |
| postgres-mas | postgres:16-alpine | ✅ Healthy | Internal:5432 | MAS database (required) |
| synapse | matrixdotorg/synapse:latest | ✅ Healthy | Internal:8008 | Matrix homeserver |
| element-web | vectorim/element-web:latest | ✅ Healthy | Internal:8080 | Web client |
| element-call | ghcr.io/element-hq/element-call:latest | ✅ Running | Internal:8080 | Video/audio calling UI |
| synapse-admin | awesometechnologies/synapse-admin:latest | ✅ Healthy | Internal:80 | Admin console |
| livekit | livekit-with-envsubst:latest | ✅ Healthy | 7880-7881, 5349, 3478, 50000-50200 | WebRTC SFU |
| lk-jwt-service | ghcr.io/element-hq/lk-jwt-service:latest | ✅ Running | Internal:8080 | LiveKit JWT generator |

### Key Configuration Decisions

#### MAS Configuration
**Critical Discovery**: MAS with MSC3861 OAuth delegation mode does NOT need static client registration in config.

**Working Configuration** (mas/config.yaml.template):
- ✅ PostgreSQL database (NOT SQLite)
- ✅ NO `clients:` section (removed - was causing validation errors)
- ✅ Minimal configuration with only essentials
- ✅ Synapse authenticates via shared secret (`MAS_SYNAPSE_SECRET`)
- ✅ Registration enabled through MAS web UI at `/account/`

**What We Learned**:
1. The error "invalid length for key default.0.client_id.clients" was NOT about client_id length
2. Static client registration is incompatible with MSC3861 delegation mode
3. MSC3861 mode handles Synapse authentication automatically via shared secret
4. MAS starts successfully with no clients defined in config

#### Database Architecture
- **Synapse**: SQLite (`./synapse/data/homeserver.db`) - local filesystem
- **MAS**: PostgreSQL (dedicated container) - REQUIRED by MAS v1.8.0+
- **MAS Data**: Separate postgres-mas container with health checks

#### Data Volumes
Using local directories (NOT /var/lib paths):
- `./synapse/data:/data` - Synapse database and media
- `./livekit/data:/var/lib/livekit` - LiveKit persistent data
- `./mas/data:/data` - MAS application data
- `./mas/postgres-data:/var/lib/postgresql/data` - PostgreSQL data

#### LiveKit Custom Build
Custom Dockerfile with multi-stage build to add shell + envsubst support to distroless LiveKit image.
This allows runtime environment variable substitution in livekit.yaml.

### Access Points
- **Element Web**: https://messaging.idfa.cc/
- **Element Call**: https://messaging.idfa.cc/call/
- **Admin Console**: https://messaging.idfa.cc/admin/
- **MAS Account Management**: https://messaging.idfa.cc/account/
- **LiveKit SFU**: wss://messaging.idfa.cc/livekit/sfu/ (internal)

### Environment Variables Required
```bash
# Core settings
SYNAPSE_SERVER_NAME=messaging.idfa.cc
SSL_CERT_DOMAIN=messaging.idfa.cc
NODE_IP=<public_ip>
TZ=UTC

# Synapse secrets
REGISTRATION_SHARED_SECRET=<generated>
MACAROON_SECRET_KEY=<generated>
FORM_SECRET=<generated>

# MAS secrets
MAS_SYNAPSE_SECRET=<shared_secret>
MAS_ADMIN_TOKEN=<generated>
MAS_POSTGRES_PASSWORD=<generated>
MAS_ENCRYPTION_SECRET=<hex_64_chars>  # Generated by init.sh

# LiveKit
LIVEKIT_SECRET=<generated>
APIKey=<generated>
```

### Deployment Steps
1. Pull latest code: `git pull`
2. Run initialization: `./init.sh`
3. Start services: `docker-compose up -d`
4. Verify all containers: `docker ps`
5. Check MAS logs: `docker logs matrix-auth-service`

### User Registration
Users register through MAS web UI:
1. Navigate to https://messaging.idfa.cc/account/
2. Click "Register" or "Create Account"
3. Fill in username and password (min 8 characters)
4. No email required (configured in MAS policy)

### MSC3861 Configuration
Synapse delegates authentication to MAS via MSC3861:
- `msc3861.enabled: true` in Synapse config
- Synapse acts as OAuth client to MAS
- Client ID: `0000000000000000000000synapse`
- Authentication: client_secret_basic with shared secret
- Admin token for MAS admin API access

### Features Enabled
- ✅ MSC3266: Room Summary API
- ✅ MSC4222: Sync v2 state_after
- ✅ MSC4140: Delayed events (MatrixRTC)
- ✅ MSC3861: OAuth delegation to MAS
- ✅ End-to-end encryption by default
- ✅ LiveKit WebRTC SFU for calls
- ✅ Element X mobile client support (via MAS)

### Known Working Commits
- Initial working MAS integration: `a4c2589` (Simplified MAS config)
- LiveKit environment variables: `a06ec3f`
- PostgreSQL for MAS: `cd30af7`
- Local data directories: `3ec9fe3`

### Troubleshooting Reference
If MAS fails to start:
1. Check logs: `docker logs matrix-auth-service`
2. Verify PostgreSQL is healthy: `docker ps` (check postgres-mas health)
3. Verify mas/config.yaml has NO `clients:` section
4. Verify encryption secret is 64 hex characters
5. Verify RSA signing key is properly indented (8 spaces)
6. Clear PostgreSQL data if needed: `rm -rf mas/postgres-data/*` and restart

### Future Maintenance
- Keep MAS config minimal - avoid adding static client registrations
- PostgreSQL is required for MAS - do not switch to SQLite
- Use local data directories to avoid permission issues
- Custom LiveKit build required for environment variable support
